<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Group Availability Scheduler</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  h1 { margin-bottom: 0; }
  label { display: block; margin: 8px 0 2px; }
  input[type="text"] { width: 200px; padding: 5px; margin-bottom: 12px; }
  table { border-collapse: collapse; margin-bottom: 20px; }
  td, th { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
  th { background-color: #eee; }
  button { padding: 8px 16px; font-size: 16px; cursor: pointer; }
  #results { white-space: pre-wrap; background: #f0f0f0; padding: 10px; border: 1px solid #ccc; }
</style>
</head>
<body>

<h1>Group Availability Scheduler</h1>

<label for="name">Your Name:</label>
<input type="text" id="name" placeholder="Enter your name" />

<form id="availability-form">
  <table>
    <thead>
      <tr>
        <th>Day / Time</th>
        <th>9am</th>
        <th>10am</th>
        <th>11am</th>
        <th>12pm</th>
        <th>1pm</th>
        <th>2pm</th>
        <th>3pm</th>
        <th>4pm</th>
        <th>5pm</th>
        <th>6pm</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Monday, July 7</td>
        <td><input type="checkbox" data-slot="mon-9"></td>
        <td><input type="checkbox" data-slot="mon-10"></td>
        <td><input type="checkbox" data-slot="mon-11"></td>
        <td><input type="checkbox" data-slot="mon-12"></td>
        <td><input type="checkbox" data-slot="mon-13"></td>
        <td><input type="checkbox" data-slot="mon-14"></td>
        <td><input type="checkbox" data-slot="mon-15"></td>
        <td><input type="checkbox" data-slot="mon-16"></td>
        <td><input type="checkbox" data-slot="mon-17"></td>
        <td><input type="checkbox" data-slot="mon-18"></td>
      </tr>
      <tr>
        <td>Tuesday, July 8</td>
        <td><input type="checkbox" data-slot="tue-9"></td>
        <td><input type="checkbox" data-slot="tue-10"></td>
        <td><input type="checkbox" data-slot="tue-11"></td>
        <td><input type="checkbox" data-slot="tue-12"></td>
        <td><input type="checkbox" data-slot="tue-13"></td>
        <td><input type="checkbox" data-slot="tue-14"></td>
        <td><input type="checkbox" data-slot="tue-15"></td>
        <td><input type="checkbox" data-slot="tue-16"></td>
        <td><input type="checkbox" data-slot="tue-17"></td>
        <td><input type="checkbox" data-slot="tue-18"></td>
      </tr>
      <tr>
        <td>Wednesday, July 9</td>
        <td><input type="checkbox" data-slot="wed-9"></td>
        <td><input type="checkbox" data-slot="wed-10"></td>
        <td><input type="checkbox" data-slot="wed-11"></td>
        <td><input type="checkbox" data-slot="wed-12"></td>
        <td><input type="checkbox" data-slot="wed-13"></td>
        <td><input type="checkbox" data-slot="wed-14"></td>
        <td><input type="checkbox" data-slot="wed-15"></td>
        <td><input type="checkbox" data-slot="wed-16"></td>
        <td><input type="checkbox" data-slot="wed-17"></td>
        <td><input type="checkbox" data-slot="wed-18"></td>
      </tr>
      <tr>
        <td>Thursday, July 10</td>
        <td><input type="checkbox" data-slot="thu-9"></td>
        <td><input type="checkbox" data-slot="thu-10"></td>
        <td><input type="checkbox" data-slot="thu-11"></td>
        <td><input type="checkbox" data-slot="thu-12"></td>
        <td><input type="checkbox" data-slot="thu-13"></td>
        <td><input type="checkbox" data-slot="thu-14"></td>
        <td><input type="checkbox" data-slot="thu-15"></td>
        <td><input type="checkbox" data-slot="thu-16"></td>
        <td><input type="checkbox" data-slot="thu-17"></td>
        <td><input type="checkbox" data-slot="thu-18"></td>
      </tr>
      <tr>
        <td>Friday, July 11</td>
        <td><input type="checkbox" data-slot="fri-9"></td>
        <td><input type="checkbox" data-slot="fri-10"></td>
        <td><input type="checkbox" data-slot="fri-11"></td>
        <td><input type="checkbox" data-slot="fri-12"></td>
        <td><input type="checkbox" data-slot="fri-13"></td>
        <td><input type="checkbox" data-slot="fri-14"></td>
        <td><input type="checkbox" data-slot="fri-15"></td>
        <td><input type="checkbox" data-slot="fri-16"></td>
        <td><input type="checkbox" data-slot="fri-17"></td>
        <td><input type="checkbox" data-slot="fri-18"></td>
      </tr>
      <tr>
        <td>Saturday, July 12</td>
        <td><input type="checkbox" data-slot="sat-9"></td>
        <td><input type="checkbox" data-slot="sat-10"></td>
        <td><input type="checkbox" data-slot="sat-11"></td>
        <td><input type="checkbox" data-slot="sat-12"></td>
        <td><input type="checkbox" data-slot="sat-13"></td>
        <td><input type="checkbox" data-slot="sat-14"></td>
        <td><input type="checkbox" data-slot="sat-15"></td>
        <td><input type="checkbox" data-slot="sat-16"></td>
        <td><input type="checkbox" data-slot="sat-17"></td>
        <td><input type="checkbox" data-slot="sat-18"></td>
      </tr>
      <tr>
        <td>Sunday, July 13</td>
        <td><input type="checkbox" data-slot="sun-9"></td>
        <td><input type="checkbox" data-slot="sun-10"></td>
        <td><input type="checkbox" data-slot="sun-11"></td>
        <td><input type="checkbox" data-slot="sun-12"></td>
        <td><input type="checkbox" data-slot="sun-13"></td>
        <td><input type="checkbox" data-slot="sun-14"></td>
        <td><input type="checkbox" data-slot="sun-15"></td>
        <td><input type="checkbox" data-slot="sun-16"></td>
        <td><input type="checkbox" data-slot="sun-17"></td>
        <td><input type="checkbox" data-slot="sun-18"></td>
      </tr>
    </tbody>
  </table>

  <button type="submit">Submit Availability</button>
</form>

<h2>Group Availability:</h2>
<div id="results">Loading...</div>

<button onclick="resetResponses()">Reset Responses</button>

<script>
  // Submit availability to server
  document.getElementById('availability-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const name = document.getElementById('name').value.trim();
    if (!name) {
      alert('Please enter your name.');
      return;
    }

    // Collect checked slots
    const slots = [];
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
      if (cb.checked) slots.push(cb.getAttribute('data-slot'));
    });

    const response = await fetch('/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, slots }),
    });

    const result = await response.json();
    if (result.success) {
      alert('Availability submitted!');
      loadAvailability();
    } else {
      alert('Error submitting availability.');
    }
  });

  // Fetch and display group availability
  async function loadAvailability() {
    const res = await fetch('/get');
    const data = await res.json();

    if (!data || Object.keys(data).length === 0) {
      document.getElementById('results').textContent = 'No responses yet.';
      return;
    }

    // Count availability per slot
    const slotCounts = {};
    // Also keep names + their slots for display
    let displayText = '';

    for (const [name, slots] of Object.entries(data)) {
      displayText += `${name}: ${slots.join(', ')}\n`;
      slots.forEach(slot => {
        slotCounts[slot] = (slotCounts[slot] || 0) + 1;
      });
    }

    // Find max availability count
    const maxCount = Math.max(...Object.values(slotCounts));
    // Find all slots with max count
    const bestSlots = Object.entries(slotCounts)
      .filter(([slot, count]) => count === maxCount)
      .map(([slot]) => slot);

    document.getElementById('results').textContent = displayText + '\nBest time(s):\n' + bestSlots.join('\n');
  }

  // Reset responses with password prompt
  async function resetResponses() {
    const pwd = prompt("Enter admin password to reset responses:");
    if (!pwd) return alert("Password is required to reset!");

    const res = await fetch('/reset', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password: pwd })
    });

    const data = await res.json();
    if (res.status === 401 || data.error) {
      alert("Wrong password! Reset cancelled.");
    } else {
      alert("All responses have been reset.");
      loadAvailability();
    }
  }

  // Load availability on page load
  window.onload = loadAvailability;
</script>

</body>
</html>
